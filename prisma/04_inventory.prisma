model Product {
    id          String    @id @default(cuid())
    sku         Int    @unique 
    name        String
    description String?
    price       Decimal?
    priceOfCost Decimal?
    barcode     String?  
    stock       Int       @default(0)
    minStock    Int       @default(1)

    categoryId String?
    category    ProductCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
    
    isActive    Boolean   @default(true)
    
    supplierId String?
    supplier Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
    
    orderItems     OrderItem[]     // Relação inversa com itens de pedido
    saleItems      SaleItem[]      // Relação inversa com itens vendidos
    stockMovements StockMovement[] // Relação inversa com movimentações
    
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    
    tenancyId String
    tenancy   Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

    @@unique([sku, tenancyId]) // SKU único por tenancy
    @@map("products")
    @@schema("inventory")
}

model ProductCategory {
    id        String   @id @default(cuid())
    name      String
    
    products  Product[]
    
    tenancyId String
    tenancy   Tenancy  @relation(fields: [tenancyId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([name, tenancyId])
    @@map("product_categories")
    @@schema("inventory")
}

// ENCOMENDAS DE CLIENTES (PDV)
model Order {
    id          String      @id @default(cuid())
    orderNumber String      // Número da encomenda para controle
    status      OrderStatus @default(PENDING)
    
    // Cliente que fez a encomenda
    studentId   String
    student     Student   @relation(fields: [studentId], references: [id], onDelete: Restrict)
    
    // Campos de entrega
    deliveryDate     DateTime? // Data de entrega esperada
    deliveredAt      DateTime? // Data real da entrega
    deliveryAddress  String?   // Endereço de entrega (se diferente do padrão)
    deliveryNotes    String?   // Observações da entrega
    
    items       OrderItem[]
    sale        Sale?       // Relação inversa com venda
    
    tenancyId   String
    tenancy     Tenancy @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
    
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    
    @@unique([orderNumber, tenancyId])
    @@map("orders")
    @@schema("inventory")
}

model OrderItem {
    id          String    @id @default(cuid())
    
    productId   String
    product     Product   @relation(fields: [productId], references: [id], onDelete: Restrict)
    
    orderId     String
    order       Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
    
    quantity    Int
    unitPrice   Decimal?
    totalPrice  Decimal?
    
    @@map("order_items")
    @@schema("inventory")
}

enum OrderStatus {
    PENDING     // Encomenda feita, aguardando preparação
    PREPARING   // Em preparação/produção
    READY       // Pronto para entrega/retirada
    DELIVERED   // Entregue ao cliente
    CANCELLED   // Encomenda cancelada
    @@schema("inventory")
}

// CONTROLE DE ESTOQUE
model StockMovement {
    id          String            @id @default(cuid())
    
    productId   String
    product     Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
    
    type        StockMovementType
    quantity    Int               // Positivo para entrada, negativo para saída
    reason      String            // Motivo da movimentação
    
    // Referência opcional para rastreabilidade de vendas
    saleItemId  String?
    saleItem    SaleItem?         @relation(fields: [saleItemId], references: [id])
    
    tenancyId   String
    tenancy     Tenancy           @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
    
    createdAt   DateTime          @default(now())
    createdBy   String?           // ID do usuário que fez a movimentação
    
    @@map("stock_movements")
    @@schema("inventory")
}

enum StockMovementType {
    INBOUND     // Entrada de mercadoria (compras, devoluções)
    SALE        // Saída por venda
    ADJUSTMENT  // Ajuste de estoque (inventário)
    LOSS        // Perda/quebra/roubo
    RETURN      // Devolução de cliente
    @@schema("inventory")
}
